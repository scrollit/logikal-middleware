# Phase 1 Deployment Guide - DigitalOcean App Platform

## üéØ **PHASE 1 COMPLETED - READY FOR UAT DEPLOYMENT**

This guide covers the deployment of the Logikal Middleware to DigitalOcean App Platform with all Phase 1 critical fixes implemented.

## ‚úÖ **PHASE 1 FIXES IMPLEMENTED**

### 1. **Environment Configuration Fixed**
- ‚úÖ Port configuration aligned (8000 across Dockerfile and DigitalOcean)
- ‚úÖ Environment variables properly configured for production
- ‚úÖ CORS and security settings configurable via environment variables

### 2. **Database Initialization Automated**
- ‚úÖ Database initialization script created (`core/database_init.py`)
- ‚úÖ Startup script handles database setup (`startup.py`)
- ‚úÖ Alembic migrations integrated
- ‚úÖ Health checks with proper startup period

### 3. **Security Hardening Implemented**
- ‚úÖ Production-grade security middleware
- ‚úÖ Configurable CORS and trusted hosts
- ‚úÖ Rate limiting with environment-based configuration
- ‚úÖ Security headers and request validation
- ‚úÖ Secret generation script for production

## üöÄ **DEPLOYMENT STEPS**

### **Step 1: Generate Production Secrets**

Run the secret generation script:

```bash
cd /home/jasperhendrickx/clients/logikal-middleware-dev
python generate_secrets.py
```

This will generate:
- `SECRET_KEY` - FastAPI secret key
- `JWT_SECRET_KEY` - JWT signing key  
- `ADMIN_PASSWORD` - Secure admin password
- Other required secrets

**‚ö†Ô∏è IMPORTANT**: Save these secrets securely and delete `production_secrets.txt` after deployment.

### **Step 2: Deploy to DigitalOcean App Platform**

1. **Push to GitHub**:
   ```bash
   git add .
   git commit -m "Phase 1: Production-ready deployment configuration"
   git push origin main
   ```

2. **Create App in DigitalOcean**:
   - Go to DigitalOcean App Platform
   - Click "Create App"
   - Select "GitHub" as source
   - Choose repository: `HendrickxJasper/logikal-middleware`
   - Select branch: `main`
   - Choose "Dockerfile" as build method

3. **Configure App Settings**:
   - **App Name**: `logikal-middleware`
   - **Dockerfile Path**: `Dockerfile`
   - **HTTP Port**: `8000`
   - **Instance Size**: `Basic XXS` (1 vCPU, 512MB RAM)
   - **Instance Count**: `1`

### **Step 3: Add Managed Database**

1. In App Platform, go to "Databases" tab
2. Click "Create Database"
3. Choose PostgreSQL 15
4. Select `db-s-dev-database` size
5. Name: `logikal-db`

### **Step 4: Configure Environment Variables**

Set the following environment variables in DigitalOcean App Platform:

#### **SECRET Variables** (Mark as SECRET):
- `SECRET_KEY` - Use generated secret
- `JWT_SECRET_KEY` - Use generated secret
- `ADMIN_USERNAME` - Set to `admin`
- `ADMIN_PASSWORD` - Use generated password
- `LOGIKAL_AUTH_USERNAME` - Set to `Jasper`
- `LOGIKAL_AUTH_PASSWORD` - Set to `OdooAPI`
- `DATABASE_URL` - Auto-generated by DigitalOcean
- `REDIS_URL` - Auto-generated if using managed Redis

#### **Public Variables**:
- `ENVIRONMENT` - Set to `production`
- `DEBUG` - Set to `false`
- `LOGIKAL_API_BASE_URL` - Set to `http://128.199.57.77/MbioeService.svc/api/v3/`
- `ADMIN_SESSION_EXPIRE_HOURS` - Set to `8`
- `LOG_LEVEL` - Set to `INFO`
- `LOG_FORMAT` - Set to `json`
- `PROMETHEUS_ENABLED` - Set to `true`
- `RATE_LIMIT_PER_MINUTE` - Set to `1000`
- `RATE_LIMIT_PER_HOUR` - Set to `10000`

### **Step 5: Configure Health Check**

- **Path**: `/api/v1/health`
- **Port**: `8000`

### **Step 6: Configure Routes**

Add the following routes:
- `/` - Main UI
- `/ui` - Admin UI
- `/api` - API endpoints
- `/docs` - API documentation
- `/redoc` - Alternative API docs
- `/metrics` - Prometheus metrics

### **Step 7: Deploy**

1. Click "Create Resources" to deploy
2. Monitor the deployment logs
3. Wait for health check to pass

## üîç **POST-DEPLOYMENT VALIDATION**

### **1. Health Check**
```bash
curl https://your-app-url.ondigitalocean.app/api/v1/health
```

Expected response:
```json
{
  "status": "healthy",
  "version": "1.0.0"
}
```

### **2. Admin UI Access**
- Navigate to `https://your-app-url.ondigitalocean.app/ui`
- Login with admin credentials
- Verify all functionality works

### **3. API Documentation**
- Navigate to `https://your-app-url.ondigitalocean.app/docs`
- Verify API documentation loads
- Test authentication endpoints

### **4. Database Connection**
- Check application logs for database initialization success
- Verify tables are created properly

## üõ†Ô∏è **TROUBLESHOOTING**

### **Common Issues**

#### **1. Application Won't Start**
- Check environment variables are set correctly
- Verify all SECRET variables are marked as SECRET
- Check database connection string

#### **2. Database Connection Failed**
- Verify DATABASE_URL is provided by DigitalOcean
- Check database is running and accessible
- Review database initialization logs

#### **3. Health Check Failing**
- Check application logs for errors
- Verify port 8000 is accessible
- Ensure startup script completes successfully

#### **4. Authentication Issues**
- Verify SECRET_KEY and JWT_SECRET_KEY are set
- Check admin credentials are correct
- Review security middleware logs

### **Log Analysis**

View application logs in DigitalOcean dashboard:
1. Go to App Platform dashboard
2. Select your app
3. Click "Runtime Logs" tab
4. Look for errors or warnings

## üìä **MONITORING**

### **Available Endpoints**
- `/api/v1/health` - Health check
- `/metrics` - Prometheus metrics
- `/docs` - API documentation

### **Key Metrics to Monitor**
- Application startup time
- Database connection status
- Authentication success rate
- API response times
- Error rates

## üîí **SECURITY NOTES**

### **Production Security Features**
- ‚úÖ Security headers (HSTS, CSP, X-Frame-Options, etc.)
- ‚úÖ Rate limiting (1000 requests/minute, 10000/hour)
- ‚úÖ Request validation and sanitization
- ‚úÖ CORS protection
- ‚úÖ Trusted host validation
- ‚úÖ Secure session management
- ‚úÖ JWT-based authentication

### **Security Best Practices**
- Rotate secrets regularly
- Monitor authentication failures
- Review security logs regularly
- Keep dependencies updated
- Use HTTPS in production

## üéâ **SUCCESS CRITERIA**

Phase 1 is complete when:
- ‚úÖ Application starts successfully on DigitalOcean
- ‚úÖ Database connection established and schema created
- ‚úÖ Admin user can log in with secure credentials
- ‚úÖ All environment variables properly configured
- ‚úÖ Health check endpoint responds correctly
- ‚úÖ Security headers and rate limiting functional
- ‚úÖ CORS properly configured for production domain

## üöÄ **NEXT STEPS**

After successful Phase 1 deployment:
1. **Phase 2**: Infrastructure setup and optimization
2. **Phase 3**: Performance testing and validation
3. **Phase 4**: UAT preparation and user training

---

**Phase 1 Status**: ‚úÖ **COMPLETE - READY FOR UAT DEPLOYMENT**
