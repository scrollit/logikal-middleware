services:
  web:
    container_name: logikal-middleware
    build: .
    ports:
      - "8001:8000"
    volumes:
      - ./app:/app
      - ./logs:/app/logs
    env_file:
      - .env.docker
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - SECRET_KEY=your-super-secret-key-change-in-production-12345678901234567890
      - JWT_SECRET_KEY=your-jwt-secret-key-change-in-production-12345678901234567890
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - LOGIKAL_API_BASE_URL=http://128.199.57.77/MbioeService.svc/api/v3/
      - LOGIKAL_AUTH_USERNAME=Jasper
      - LOGIKAL_AUTH_PASSWORD=OdooAPI
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=text
      - PROMETHEUS_ENABLED=true
      - RATE_LIMIT_PER_MINUTE=1000
      - RATE_LIMIT_PER_HOUR=10000
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin123
      - ADMIN_SESSION_EXPIRE_HOURS=8
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    container_name: logikal-db
    restart: always
    environment:
      POSTGRES_DB: logikal_middleware
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    ports:
      - "5433:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: logikal-redis
    ports:
      - "6379:6379"

  celery-worker:
    container_name: logikal-celery-worker
    build: .
    command: celery -A celery_app worker --loglevel=info --queues=sync,scheduler
    volumes:
      - ./app:/app
    env_file:
      - .env.docker
    depends_on:
      - db
      - redis
    environment:
      - C_FORCE_ROOT=1

  celery-beat:
    container_name: logikal-celery-beat
    build: .
    command: celery -A celery_app beat --loglevel=info
    volumes:
      - ./app:/app
    env_file:
      - .env.docker
    depends_on:
      - db
      - redis
    environment:
      - C_FORCE_ROOT=1

  flower:
    container_name: logikal-flower
    build: .
    command: celery -A celery_app flower --port=5555
    ports:
      - "5555:5555"
    volumes:
      - ./app:/app
    env_file:
      - .env.docker
    depends_on:
      - redis

volumes:
  pgdata:
